{"version":3,"file":"rete-context-menu-plugin.min.js","sources":["src/presets/classic/factory.ts","src/presets/classic/index.ts","src/index.ts"],"sourcesContent":["import { NodeEditor } from 'rete'\nimport { BaseAreaPlugin } from 'rete-area-plugin'\n\nimport { Item } from '../../types'\nimport { BSchemes, ItemDefinition } from './types'\n\nexport function createItem<S extends BSchemes>(\n  [label, factory]: ItemDefinition<S>,\n  key: string | number,\n  context: { editor: NodeEditor<S>, area: BaseAreaPlugin<S, any> }\n): Item {\n  const item = {\n    label,\n    key: String(key)\n  }\n\n  if (typeof factory === 'function') {\n    return <Item>{\n      ...item,\n      async handler() {\n        const node = await factory()\n\n        await context.editor.addNode(node)\n\n        context.area.translate(node.id, context.area.area.pointer)\n      }\n    }\n  }\n  return <Item>{\n    ...item,\n    handler() {/* do nothing */},\n    subitems: factory.map((data, i) => createItem(data, i, context))\n  }\n}\n","import { NodeEditor } from 'rete'\nimport { BaseAreaPlugin } from 'rete-area-plugin'\n\nimport { Item, Items } from '../../types'\nimport { createItem } from './factory'\nimport { BSchemes, ItemDefinition } from './types'\n\n/**\n * Classic context menu preset.\n * Configures nodes/actions items for root and Delete/Clone items for nodes\n * @param nodes List of items\n * @example Presets.classic.setup([\n  [\"Math\", [\n    [\"Number\", () => new NumberNode()],\n  ]]\n])\n */\nexport function setup<Schemes extends BSchemes>(nodes: ItemDefinition<Schemes>[]) {\n  return <Items<Schemes>>(function (context, plugin) {\n    const area = plugin.parentScope<BaseAreaPlugin<Schemes, any>>(BaseAreaPlugin)\n    const editor = area.parentScope<NodeEditor<Schemes>>(NodeEditor)\n\n    if (context === 'root') {\n      return {\n        searchBar: true,\n        list: nodes.map((item, i) => createItem(item, i, { editor, area }))\n      }\n    }\n\n    const deleteItem: Item = {\n      label: 'Delete',\n      key: 'delete',\n      async handler() {\n        if ('source' in context && 'target' in context) {\n          // connection\n          const connectionId = context.id\n\n          await editor.removeConnection(connectionId)\n        } else {\n          // node\n          const nodeId = context.id\n          const connections = editor.getConnections().filter(c => {\n            return c.source === nodeId || c.target === nodeId\n          })\n\n          for (const connection of connections) {\n            await editor.removeConnection(connection.id)\n          }\n          await editor.removeNode(nodeId)\n        }\n      }\n    }\n\n    const clone = context.clone\n    const cloneItem: undefined | Item = clone && {\n      label: 'Clone',\n      key: 'clone',\n      async handler() {\n        const node = clone()\n\n        await editor.addNode(node)\n\n        area.translate(node.id, area.area.pointer)\n      }\n    }\n\n    return {\n      searchBar: false,\n      list: [\n        deleteItem,\n        ...(cloneItem ? [cloneItem] : [])\n      ]\n    }\n  })\n}\n","import { BaseSchemes, Scope } from 'rete'\nimport { BaseArea, BaseAreaPlugin, RenderSignal } from 'rete-area-plugin'\n\nimport { Item, Items, Position } from './types'\n\nexport * as Presets from './presets'\n\n/**\n * Context menu plugin props\n * @priority 8\n */\nexport type Props<Schemes extends BaseSchemes> = {\n  /** delay before hiding context menu */\n  delay?: number\n  /** menu items, can be produced by preset */\n  items: Items<Schemes>\n}\nexport type RenderMeta = { filled?: boolean }\n\n/**\n * Signal types produced by ContextMenuPlugin instance\n * @priority 10\n */\nexport type ContextMenuExtra =\n  | RenderSignal<'contextmenu', {\n    items: Item[]\n    onHide(): void\n    searchBar?: boolean\n  }>\n\ntype Requires<Schemes extends BaseSchemes> =\n  | { type: 'contextmenu', data: { event: MouseEvent, context: 'root' | Schemes['Node'] | Schemes['Connection'] } }\n  | { type: 'unmount', data: { element: HTMLElement } }\n  | { type: 'pointerdown', data: { position: Position, event: PointerEvent } }\n\n/**\n * Plugin for context menu.\n * Responsible for initialing rendering of context menu with predefined items.\n * @priority 9\n * @emits render\n * @emits unmount\n * @listens unmount\n * @listens contextmenu\n * @listens pointerdown\n */\nexport class ContextMenuPlugin<Schemes extends BaseSchemes> extends Scope<never, [Requires<Schemes> | ContextMenuExtra]> {\n  /**\n   * @param props Properties\n   */\n  constructor(private props: Props<Schemes>) {\n    super('context-menu')\n  }\n\n  setParent(scope: Scope<Requires<Schemes>>): void {\n    super.setParent(scope)\n\n    const area = this.parentScope<BaseAreaPlugin<Schemes, BaseArea<Schemes>>>(BaseAreaPlugin)\n    const container: HTMLElement = (area as any).container\n\n    if (!container || !(container instanceof HTMLElement)) throw new Error('container expected')\n\n    const element = document.createElement('div')\n\n    element.style.display = 'none'\n    element.style.position = 'fixed'\n\n    // eslint-disable-next-line max-statements\n    this.addPipe(context => {\n      const parent = this.parentScope()\n\n      if (!context || typeof context !== 'object' || !('type' in context)) return context\n      if (context.type === 'unmount') {\n        if (context.data.element === element) {\n          element.style.display = 'none'\n        }\n      } else if (context.type === 'contextmenu') {\n        context.data.event.preventDefault()\n        context.data.event.stopPropagation()\n\n        const { searchBar, list } = this.props.items(context.data.context, this)\n\n        container.appendChild(element)\n        element.style.left = `${context.data.event.clientX}px`\n        element.style.top = `${context.data.event.clientY}px`\n        element.style.display = ''\n\n        parent.emit({\n          type: 'render',\n          data: {\n            type: 'contextmenu',\n            element,\n            searchBar,\n            onHide() {\n              parent.emit({ type: 'unmount', data: { element } })\n            },\n            items: list\n          }\n        })\n      } else if (context.type === 'pointerdown') {\n        if (!context.data.event.composedPath().includes(element)) {\n          parent.emit({ type: 'unmount', data: { element } })\n        }\n      }\n      return context\n    })\n  }\n}\n"],"names":["createItem","_ref","key","context","_ref2","_slicedToArray","label","factory","item","String","_objectSpread","handler","_asyncToGenerator","_regeneratorRuntime","mark","_callee","node","wrap","_context","prev","next","sent","editor","addNode","area","translate","id","pointer","stop","subitems","map","data","i","nodes","plugin","parentScope","BaseAreaPlugin","NodeEditor","searchBar","list","deleteItem","connectionId","nodeId","connections","_iterator","_step","connection","removeConnection","getConnections","filter","c","source","target","_createForOfIteratorHelper","s","n","done","value","t0","e","f","finish","removeNode","clone","cloneItem","_callee2","_context2","concat","_toConsumableArray","ContextMenuPlugin","_Scope","_inherits","_super","_createSuper","props","_this","_classCallCheck","call","scope","_this2","this","_get","_getPrototypeOf","prototype","container","HTMLElement","Error","element","document","createElement","style","display","position","addPipe","parent","_typeof","type","event","preventDefault","stopPropagation","_this2$props$items","items","appendChild","left","clientX","top","clientY","emit","onHide","composedPath","includes","Scope"],"mappings":"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"}